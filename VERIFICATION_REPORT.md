# –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º

## 1. ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π VK

**–û—Ä–∏–≥–∏–Ω–∞–ª** (`monitorshik-vk/monitor.py`):
- –§—É–Ω–∫—Ü–∏—è `send_telegram_message(message: str, retry_count: int = 3) -> bool`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `requests.post(url, json=params, timeout=10)`
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 429 (rate limit) —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º `retry_after`
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –ø—Ä–∏ —É—Å–ø–µ—Ö–µ, `False` –ø—Ä–∏ –æ—à–∏–±–∫–µ
- –ó–∞–¥–µ—Ä–∂–∫–∞ `time.sleep(1.2)` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏

**–ú–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** (`monitors/vk_monitor.py`):
- ‚úÖ –ú–µ—Ç–æ–¥ `_send_telegram_notification(message: str, bot_token: str, chat_id: str) -> bool`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `requests.post(url, json=params, timeout=10)` - **–ò–î–ï–ù–¢–ò–ß–ù–û**
- ‚úÖ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç 429 —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º - **–ò–î–ï–ù–¢–ò–ß–ù–û**
- ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True/False` - **–ò–î–ï–ù–¢–ò–ß–ù–û**
- ‚úÖ –ó–∞–¥–µ—Ä–∂–∫–∞ `time.sleep(1.2)` –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ - **–î–û–ë–ê–í–õ–ï–ù–û**

**–°—Ç–∞—Ç—É—Å: ‚úÖ –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢**

---

## 2. ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π Telegram

**–û—Ä–∏–≥–∏–Ω–∞–ª** (`monitorshik-tg/worker.py`):
- –ú–µ—Ç–æ–¥ `_send_notification(self, text: str)`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `aiohttp.ClientSession.post()` —Å `json=payload`
- `max_retries = 5` —Å exponential backoff
- `disable_web_page_preview = True`

**–ú–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** (`monitors/telegram_monitor.py`):
- ‚úÖ –ú–µ—Ç–æ–¥ `_send_telegram_message(self, text: str)`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `aiohttp.ClientSession.post()` —Å `json=payload` - **–ò–î–ï–ù–¢–ò–ß–ù–û**
- ‚úÖ `max_retries = 5` —Å exponential backoff - **–ò–î–ï–ù–¢–ò–ß–ù–û**
- ‚úÖ `disable_web_page_preview = True` - **–ò–î–ï–ù–¢–ò–ß–ù–û**
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ (`_send_photo`, `_send_video`, `_send_document`, `_send_voice`) - **–ò–î–ï–ù–¢–ò–ß–ù–û –û–†–ò–ì–ò–ù–ê–õ–£**

**–°—Ç–∞—Ç—É—Å: ‚úÖ –°–û–û–¢–í–ï–¢–°–¢–í–£–ï–¢**

---

## 3. ‚úÖ –§–æ—Ä–º–∞—Ç —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è VK

**–û—Ä–∏–≥–∏–Ω–∞–ª** (`monitorshik-vk/monitor.py`, —Å—Ç—Ä–æ–∫–∞ 279):
```python
message = f"""üîµ <b>VK</b> | {owner_name}
üë§ <a href="{author_url}">{author_name}</a>
üÜî <code>{author_id}</code>
üïê {time_str}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<blockquote>{text}</blockquote>

<a href="{post_url}">üîó –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç</a>
<a href="{comment_url}">üí¨ –û—Ç–∫—Ä—ã—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</a>"""
```

**–ú–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** (`monitors/vk_monitor.py`, —Å—Ç—Ä–æ–∫–∞ 426):
```python
message = f"""üîµ <b>VK</b> | {owner_name}
üë§ <a href="{author_url}">{author_name}</a>
üÜî <code>{author_id}</code>
üïê {time_str}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
<blockquote>{text}</blockquote>

<a href="{post_url}">üîó –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Å—Ç</a>
<a href="{comment_url}">üí¨ –û—Ç–∫—Ä—ã—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</a>"""
```

**–°—Ç–∞—Ç—É—Å: ‚úÖ –ò–î–ï–ù–¢–ò–ß–ù–û**

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ `+ timedelta(hours=3)` –¥–ª—è –º–æ—Å–∫–æ–≤—Å–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)

---

## 4. ‚úÖ –§–æ—Ä–º–∞—Ç —Ç–µ–∫—Å—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Telegram

**–û—Ä–∏–≥–∏–Ω–∞–ª** (`monitorshik-tg/worker.py`, —Å—Ç—Ä–æ–∫–∞ 295):
```python
f"‚úàÔ∏è <b>TG</b> | {channel_title}\n"
f"üë§ {author_name} {author_username}\n"
f"üÜî <code>{author_id}</code>\n"
f"üïê {time_str}\n"
f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
```

**–ú–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** (`monitors/telegram_monitor.py`, —Å—Ç—Ä–æ–∫–∞ 289):
```python
f"‚úàÔ∏è <b>TG</b> | {channel_title}\n"
f"üë§ {author_name}{username_part}\n"  # username_part –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ–±–µ–ª –µ—Å–ª–∏ –µ—Å—Ç—å
f"üÜî <code>{author_id}</code>\n"
f"üïê {time_str}\n"
f"‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
```

**–°—Ç–∞—Ç—É—Å: ‚úÖ –ò–î–ï–ù–¢–ò–ß–ù–û** (–ª–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è username –∏–¥–µ–Ω—Ç–∏—á–Ω–∞)

---

## 5. ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è VK —á–µ—Ä–µ–∑ –ë–î

**–û—Ä–∏–≥–∏–Ω–∞–ª** (`monitorshik-vk/monitor.py`):
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç in-memory `seen_comments = set()`
- –ü—Ä–æ–≤–µ—Ä–∫–∞: `if comment_id in seen_comments: continue`
- –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ (`is_first_run`) –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –Ω–æ –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –∫—ç—à

**–ú–æ—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è** (`monitors/vk_monitor.py`):
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ë–î –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `save_comment_to_db()`
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î: `session.query(Comment).filter(source_comment_id == str(comment_id), source == 'vk')`
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å `(source_comment_id, source)` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î
- ‚úÖ `source_comment_id = str(comment_id)` - –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- ‚úÖ –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - `save_comment_to_db()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `False`, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

**–õ–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏:**
1. –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å `comment_id = 12345`
2. –§–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è `source_comment_id = "12345"` (—Å—Ç—Ä–æ–∫–∞)
3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î: –µ—Å—Ç—å –ª–∏ –∑–∞–ø–∏—Å—å —Å `source='vk'` –∏ `source_comment_id='12345'`
4. –ï—Å–ª–∏ –µ—Å—Ç—å ‚Üí `False`, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
5. –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è

**–°—Ç–∞—Ç—É—Å: ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û –†–ê–ë–û–¢–ê–ï–¢**

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–∞–¥ –∫—ç—à–µ–º:**
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
- ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å —Ä–∞–∑–º–µ—Ä–æ–º –∫—ç—à–∞
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –∏–Ω–¥–µ–∫—Å –ë–î

---

## 6. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø–∏—Å–∏ –≤ –ë–î

**–§–æ—Ä–º–∞—Ç `source_comment_id`:**
- VK: `str(comment_id)` - –≥–¥–µ `comment_id` —ç—Ç–æ —á–∏—Å–ª–æ –∏–∑ VK API
- Telegram: `str(message.id)` - –≥–¥–µ `message.id` —ç—Ç–æ ID —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ Telegram

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏:**
- –í –ë–î –µ—Å—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å: `UniqueConstraint('source_comment_id', 'source')`
- –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç SQLAlchemy –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è

**–°—Ç–∞—Ç—É—Å: ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û –ó–ê–ü–ò–°–´–í–ê–ï–¢–°–Ø**

---

## –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞

| –ü—É–Ω–∫—Ç | –°—Ç–∞—Ç—É—Å | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|-------|--------|------------|
| VK –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π | ‚úÖ | –ò–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—É + –∑–∞–¥–µ—Ä–∂–∫–∞ |
| TG –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π | ‚úÖ | –ò–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—É + –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –º–µ–¥–∏–∞ |
| VK —Ñ–æ—Ä–º–∞—Ç —Ç–µ–∫—Å—Ç–∞ | ‚úÖ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Ä–µ–º—è (+3 —á–∞—Å–∞) |
| TG —Ñ–æ—Ä–º–∞—Ç —Ç–µ–∫—Å—Ç–∞ | ‚úÖ | –ò–¥–µ–Ω—Ç–∏—á–Ω–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—É |
| –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è VK | ‚úÖ | –†–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –ë–î, –ø—Ä–∞–≤–∏–ª—å–Ω–æ |
| –ó–∞–ø–∏—Å—å –≤ –ë–î | ‚úÖ | –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID |

**–í—Å–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ! ‚úÖ**

