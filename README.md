# Unified Monitor - VK & Telegram Comment Monitor

Объединенный монитор комментариев из ВКонтакте и Telegram с интеграцией SQLite базы данных и анализом тональности через API Яндекс.

## Возможности

- ✅ Мониторинг комментариев из Telegram каналов (дискуссионные группы)
- ✅ Мониторинг комментариев из ВКонтакте (группы и страницы пользователей)
- ✅ Сохранение всех комментариев в SQLite базу данных
- ✅ Дедупликация комментариев
- ✅ Анализ тональности комментариев через API Яндекс
- ✅ Модульная архитектура для легкого расширения

## Структура проекта

```
dev-monitorshik-test/
├── monitors/              # Мониторщики
│   ├── base.py           # Базовый класс
│   ├── telegram_monitor.py
│   └── vk_monitor.py
├── database/             # Работа с БД
│   ├── models.py         # SQLAlchemy модели
│   └── db_manager.py     # Управление БД
├── sentiment/            # Анализ тональности
│   └── yandex_analyzer.py
├── config/               # Конфигурация
│   └── settings.py
├── utils/               # Утилиты
├── main.py              # Точка входа
├── requirements.txt     # Зависимости
├── env.example          # Пример конфигурации
└── db.md               # Схема базы данных
```

## Установка

1. **Клонируйте проект** (если еще не клонировали):
```bash
cd dev-monitorshik-test
```

2. **Установите зависимости**:
```bash
pip install -r requirements.txt
```

3. **Настройте переменные окружения**:
Скопируйте `env.example` в `.env` и заполните необходимые переменные:
```bash
cp env.example .env
nano .env  # или используйте ваш редактор
```

### Необходимые переменные окружения

#### Для Telegram монитора:
- `TG_API_ID` - API ID из https://my.telegram.org
- `TG_API_HASH` - API Hash из https://my.telegram.org
- `TG_STRING_SESSION` - String Session (получите через `generate_session.py` из репозитория monitorshik-tg)
- `CHANNELS` - список username каналов через запятую (без @)

#### Для VK монитора:
- `VK_ACCESS_TOKEN` - токен доступа VK API (получите на https://vk.com/apps?act=manage, права: wall, offline)
- `VK_GROUP_ID` - ID или screen name группы/пользователя для мониторинга

#### Для анализа тональности:
- `YANDEX_API_KEY` - API ключ от Yandex Cloud (опционально, если не указан - анализ тональности отключен)

#### Опциональные переменные:
- `DB_PATH` - путь к файлу БД (по умолчанию: `comments.db`)
- `TZ` - временная зона (по умолчанию: UTC)
- `POSTS_TO_CHECK` - количество постов для проверки в VK (по умолчанию: 10)
- `COMMENTS_PER_POST` - количество комментариев на пост в VK (по умолчанию: 20)
- `CHECK_INTERVAL` - интервал проверки VK в секундах (по умолчанию: 60)
- `SENTIMENT_INTERVAL` - интервал обработки тональности в секундах (по умолчанию: 60)

## Запуск

```bash
python main.py
```

Приложение:
1. Инициализирует базу данных (создаст файл `comments.db` если его нет)
2. Запустит Telegram монитор (если настроен)
3. Запустит VK монитор (если настроен)
4. Запустит worker для анализа тональности (если настроен YANDEX_API_KEY)

Для остановки нажмите `Ctrl+C`.

## База данных

База данных SQLite создается автоматически при первом запуске. Схема базы данных описана в `db.md`.

### Основные таблицы:

- `comments` - таблица со всеми комментариями

### Индексы:

- Уникальный индекс на `(source_comment_id, source)` для дедупликации
- Индекс на `comment_published_at` для фильтров по датам
- Индекс на `processed` для поиска необработанных комментариев

### Просмотр данных:

Вы можете использовать любой SQLite клиент для просмотра данных:
```bash
sqlite3 comments.db
```

Примеры запросов:
```sql
-- Все комментарии
SELECT * FROM comments LIMIT 10;

-- Статистика по источникам
SELECT source, COUNT(*) FROM comments GROUP BY source;

-- Необработанные комментарии
SELECT COUNT(*) FROM comments WHERE processed = 0;

-- Комментарии с анализом тональности
SELECT sentiment, COUNT(*) FROM comments WHERE sentiment IS NOT NULL GROUP BY sentiment;
```

## Анализ тональности

Анализ тональности выполняется автоматически в фоновом режиме для всех необработанных комментариев.

**Важно**: В текущей версии реализован простой placeholder для анализа тональности. Для реального использования необходимо:

1. Получить API ключ от Yandex Cloud
2. Обновить метод `analyze_text` в `sentiment/yandex_analyzer.py` для работы с реальным API Яндекс

Текущая placeholder-реализация использует простой keyword-based анализ (ключевые слова на русском языке).

## Логирование

Все события логируются в консоль с временными метками. Формат:
```
YYYY-MM-DD HH:MM:SS - module - LEVEL - message
```

## Разработка

### Структура модулей:

- **monitors/base.py** - базовый класс для всех мониторщиков
- **monitors/telegram_monitor.py** - монитор Telegram (async, использует Telethon)
- **monitors/vk_monitor.py** - монитор VK (sync, работает в отдельном потоке)
- **database/models.py** - SQLAlchemy модели
- **database/db_manager.py** - управление БД, дедупликация
- **sentiment/yandex_analyzer.py** - интеграция с API Яндекс для анализа тональности

### Добавление нового источника:

1. Создайте класс, наследующийся от `BaseMonitor`
2. Реализуйте методы `start()` и `stop()`
3. Используйте `save_comment_to_db()` для сохранения комментариев
4. Добавьте конфигурацию в `config/settings.py`
5. Добавьте запуск в `main.py`

## Лицензия

MIT

## Поддержка

При возникновении проблем:
1. Проверьте логи приложения
2. Убедитесь, что все переменные окружения установлены правильно
3. Проверьте доступность источников (каналы Telegram, группы VK)
4. Убедитесь, что база данных создана и доступна для записи

